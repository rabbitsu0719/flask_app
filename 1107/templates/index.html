<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>TrOCR 시각화</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, sans-serif; background:#0b1020; color:#e9f1ff; margin:0; }
    header { padding:20px 24px; display:flex; justify-content:space-between; align-items:center; }
    .wrap { max-width:980px; margin:0 auto; padding:0 16px 40px; }
    .card { background:#111834; border:1px solid #1d2746; border-radius:16px; padding:16px; margin:16px 0; }
    .btn { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    .btn.primary { background:#2a64ff; color:#fff; }
    .btn.gray { background:#2b324c; color:#e9f1ff; }
    input[type=file]{ padding:8px; border-radius:10px; border:1px solid #2b324c; background:#0f1430; color:#cfe3ff }
    #canvas { width:100%; max-width:940px; border:1px solid #26304d; border-radius:12px; display:block; background:#090f22; }
    pre { white-space:pre-wrap; background:#0f1430; padding:12px; border-radius:10px; }
  </style>
</head>
<body>
  <header>
    <h2>TrOCR 시각화</h2>
    <nav>
      안녕하세요, {{ username }}님&nbsp;&nbsp;
      <a href="/history" style="color:#9ec1ff">히스토리</a> |
      <a href="/logout" style="color:#9ec1ff">로그아웃</a>
    </nav>
  </header>

  <div class="wrap">
    <div class="card">
      <h3>파일 업로드 / 카메라</h3>
      <!-- ✅ 폼 자동 submit 절대 금지 -->
      <form id="uform" onsubmit="return false;">
        <input id="file" type="file" accept="image/*" capture="environment">
        <button id="run" type="button" class="btn primary">OCR 실행</button>
        <button id="save" type="button" class="btn gray">시각화 캡처 저장</button>
      </form>
      <div id="status" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <canvas id="canvas"></canvas>
    </div>

    <div class="card">
      <h4>응답(JSON, 디버그용)</h4>
      <pre id="json"></pre>
    </div>
  </div>

<script>
const API_BASE = location.origin; // http://61.109.238.77:5000

const fileEl   = document.getElementById('file');
const runBtn   = document.getElementById('run');
const saveBtn  = document.getElementById('save');
const statusEl = document.getElementById('status');
const canvas   = document.getElementById('canvas');
const ctx      = canvas.getContext('2d');
const jsonEl   = document.getElementById('json');

function setStatus(msg){ statusEl.textContent = msg; console.log('[STATUS]', msg); }

// 이미지 로드: Safari 안전(우선 createImageBitmap, 실패 시 ObjectURL)
async function loadBitmapFromFile(file){
  try {
    return await createImageBitmap(file);
  } catch {
    return await new Promise((resolve, reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload  = () => { URL.revokeObjectURL(url); resolve(img); };
      img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('이미지 로드 실패')); };
      img.src = url;
    });
  }
}

// 캔버스 리사이즈+그리기 (가로 940px 제한)
function fitAndDrawImage(bmp){
  const maxW = 940;
  const scale = bmp.width > maxW ? maxW / bmp.width : 1;
  canvas.width  = Math.round(bmp.width  * scale);
  canvas.height = Math.round(bmp.height * scale);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);
  return scale;
}

// bbox/quad 정규화
function toRect(b, W, H){
  if (!Array.isArray(b) || b.length !== 4) return null;
  const norm = b.every(v => v >= 0 && v <= 1);
  let x0=b[0], y0=b[1], x1=b[2], y1=b[3];
  if (norm){ x0*=W; y0*=H; x1*=W; y1*=H; }
  let w=x1-x0, h=y1-y0;
  if (w<=0 || h<=0){
    let x=b[0], y=b[1], ww=b[2], hh=b[3];
    if (norm){ x*=W; y*=H; ww*=W; hh*=H; }
    x0=x; y0=y; w=ww; h=hh;
  }
  x0 = Math.max(0, Math.min(x0, W));
  y0 = Math.max(0, Math.min(y0, H));
  w  = Math.max(1, Math.min(w,  W - x0));
  h  = Math.max(1, Math.min(h,  H - y0));
  return {x:x0, y:y0, w, h};
}
function toQuad(q, W, H){
  if (!Array.isArray(q) || q.length !== 4) return null;
  const norm = q.flat().every(v => v>=0 && v<=1);
  return q.map(([x,y]) => norm ? [x*W, y*H] : [x,y]);
}

// 하이라이트 그리기
function drawItems(items, scale){
  ctx.lineWidth = 2;
  ctx.font = '14px system-ui';

  let drawn = 0;
  for (const it of (items||[])){
    // quad 우선
    let pathDrawn = false;
    if (it.quad){
      const q = toQuad(it.quad, canvas.width, canvas.height);
      if (q){
        ctx.beginPath();
        ctx.moveTo(q[0][0], q[0][1]);
        for (let i=1;i<q.length;i++) ctx.lineTo(q[i][0], q[i][1]);
        ctx.closePath();
        ctx.strokeStyle = '#ffd54a';
        ctx.fillStyle   = 'rgba(255,213,74,0.18)';
        ctx.fill();
        ctx.stroke();
        // 라벨
        const [x,y] = q[0];
        const text  = it.text || '';
        const w     = ctx.measureText(text).width + 10;
        ctx.fillStyle = 'rgba(0,0,0,0.55)';
        ctx.fillRect(x, y-20, w, 18);
        ctx.fillStyle = '#fff';
        ctx.fillText(text, x+5, y-6);
        drawn++; pathDrawn = true;
      }
    }
    // bbox 폴백
    if (!pathDrawn && (it.bbox || it.box || it.rect)){
      const r = toRect(it.bbox || it.box || it.rect, canvas.width, canvas.height);
      if (!r) continue;
      ctx.strokeStyle = '#ffd54a';
      ctx.fillStyle   = 'rgba(255,213,74,0.18)';
      ctx.fillRect(r.x, r.y, r.w, r.h);
      ctx.strokeRect(r.x, r.y, r.w, r.h);
      const text = it.text || '';
      const w    = ctx.measureText(text).width + 10;
      ctx.fillStyle = 'rgba(0,0,0,0.55)';
      ctx.fillRect(r.x, r.y-20, w, 18);
      ctx.fillStyle = '#fff';
      ctx.fillText(text, r.x+5, r.y-6);
      drawn++;
    }
  }
  return drawn;
}

// -------- 메인 --------
runBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  try{
    const f = fileEl.files?.[0];
    if(!f){ setStatus('이미지를 선택하세요.'); return; }

    // 1) 클라이언트에서 이미지 먼저 그림
    const bmp = await loadBitmapFromFile(f);
    const scale = fitAndDrawImage(bmp);

    // 2) 서버로 업로드 & OCR
    setStatus('업로드 중…');
    const fd = new FormData(); fd.append('file', f);
    const res = await fetch(`${API_BASE}/api/ocr`, {
      method:'POST',
      body: fd,
      credentials:'include'
    });

    console.log('OCR status', res.status);
    if(res.status === 401){ setStatus('로그인 만료. 다시 로그인하세요.'); return; }
    if(!res.ok){ setStatus('서버 오류'); jsonEl.textContent = await res.text(); return; }

    const data = await res.json();
    jsonEl.textContent = JSON.stringify(data, null, 2);

    setStatus('시각화 중…');
    const drawn = drawItems(data.items || [], scale);
    setStatus(drawn ? `완료 ✅ (${drawn}개)` : '완료(표시할 박스 없음)');
  }catch(err){
    console.error(err);
    setStatus('클라이언트 오류: ' + (err?.message || err));
  }
});

// 캔버스 캡처 저장
saveBtn.addEventListener('click', async ()=>{
  canvas.toBlob(async (blob)=>{
    if(!blob){ setStatus('캡처 실패'); return; }
    const fd = new FormData();
    fd.append('file', new File([blob], 'capture.png', {type:'image/png'}));
    try{
      const r = await fetch(`${API_BASE}/api/capture`, {
        method:'POST',
        body: fd,
        credentials:'include'
      });
      const j = await r.json().catch(()=>({ok:false}));
      setStatus(j.ok ? ('캡처 저장됨: ' + j.saved) : '캡처 저장 실패');
    }catch(e){
      setStatus('캡처 업로드 오류: ' + e.message);
    }
  });
});
</script>
